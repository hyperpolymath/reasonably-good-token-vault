#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Hyperpolymath
#
# Pre-commit hook - Maximum security validation

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║           SVALINN VAULT PRE-COMMIT VALIDATION                ║"
echo "╚══════════════════════════════════════════════════════════════╝"

# ===========================================================================
# Check for secrets
# ===========================================================================
echo -n "Checking for secrets... "
if command -v gitleaks &> /dev/null; then
    if gitleaks detect --source . --no-git --quiet 2>/dev/null; then
        echo -e "${GREEN}PASS${NC}"
    else
        echo -e "${RED}FAIL${NC}"
        echo "ERROR: Potential secrets detected! Run 'gitleaks detect' for details."
        exit 1
    fi
else
    echo -e "${YELLOW}SKIP${NC} (gitleaks not installed)"
fi

# ===========================================================================
# Check SPDX headers
# ===========================================================================
echo -n "Checking SPDX headers... "
MISSING_SPDX=0
for f in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(zig|sats|dats|scm|ncl|rs|sh)$'); do
    if ! head -5 "$f" 2>/dev/null | grep -q "SPDX-License-Identifier"; then
        echo -e "\n  Missing SPDX header: $f"
        MISSING_SPDX=1
    fi
done
if [ $MISSING_SPDX -eq 0 ]; then
    echo -e "${GREEN}PASS${NC}"
else
    echo -e "${RED}FAIL${NC}"
    exit 1
fi

# ===========================================================================
# Check for banned algorithms
# ===========================================================================
echo -n "Checking for banned algorithms... "
BANNED_PATTERNS="MD5|SHA1|DES|3DES|RC4|RC2|IDEA|Blowfish"
if git diff --cached --name-only --diff-filter=ACM | xargs grep -l -E "$BANNED_PATTERNS" 2>/dev/null; then
    echo -e "${RED}FAIL${NC}"
    echo "ERROR: Banned cryptographic algorithm detected!"
    exit 1
else
    echo -e "${GREEN}PASS${NC}"
fi

# ===========================================================================
# Check for hardcoded IPs/URLs
# ===========================================================================
echo -n "Checking for hardcoded IPs... "
IP_PATTERN='[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'
SUSPICIOUS=$(git diff --cached | grep -E "^\+" | grep -v "^+++" | grep -oE "$IP_PATTERN" | grep -v "127\.0\.0\.1" | grep -v "0\.0\.0\.0" || true)
if [ -n "$SUSPICIOUS" ]; then
    echo -e "${YELLOW}WARN${NC}"
    echo "  Found hardcoded IPs: $SUSPICIOUS"
else
    echo -e "${GREEN}PASS${NC}"
fi

# ===========================================================================
# Zig format check
# ===========================================================================
echo -n "Checking Zig formatting... "
if command -v zig &> /dev/null; then
    ZIG_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.zig$' || true)
    if [ -n "$ZIG_FILES" ]; then
        if zig fmt --check $ZIG_FILES 2>/dev/null; then
            echo -e "${GREEN}PASS${NC}"
        else
            echo -e "${RED}FAIL${NC}"
            echo "Run 'zig fmt' to fix formatting"
            exit 1
        fi
    else
        echo -e "${GREEN}PASS${NC} (no Zig files)"
    fi
else
    echo -e "${YELLOW}SKIP${NC} (zig not installed)"
fi

# ===========================================================================
# ATS type check
# ===========================================================================
echo -n "Checking ATS types... "
if command -v patsopt &> /dev/null; then
    ATS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sats|dats)$' || true)
    if [ -n "$ATS_FILES" ]; then
        for f in $ATS_FILES; do
            if [[ "$f" == *.sats ]]; then
                patsopt --typecheck-only -s "$f" 2>/dev/null || {
                    echo -e "${RED}FAIL${NC}"
                    exit 1
                }
            elif [[ "$f" == *.dats ]]; then
                patsopt --typecheck-only -d "$f" 2>/dev/null || {
                    echo -e "${RED}FAIL${NC}"
                    exit 1
                }
            fi
        done
        echo -e "${GREEN}PASS${NC}"
    else
        echo -e "${GREEN}PASS${NC} (no ATS files)"
    fi
else
    echo -e "${YELLOW}SKIP${NC} (patsopt not installed)"
fi

# ===========================================================================
# Check file permissions
# ===========================================================================
echo -n "Checking file permissions... "
EXECUTABLE=$(git diff --cached --name-only --diff-filter=ACM | xargs -I {} stat -c "%a %n" {} 2>/dev/null | grep -E "^7" || true)
if [ -n "$EXECUTABLE" ]; then
    echo -e "${YELLOW}WARN${NC}"
    echo "  Executable files: $EXECUTABLE"
else
    echo -e "${GREEN}PASS${NC}"
fi

# ===========================================================================
# Mustfile validation
# ===========================================================================
echo -n "Validating Mustfile... "
if [ -f "Mustfile" ]; then
    # Basic structure check
    if grep -q "require_signed_commits = true" Mustfile && \
       grep -q "no_force_push = true" Mustfile; then
        echo -e "${GREEN}PASS${NC}"
    else
        echo -e "${RED}FAIL${NC}"
        echo "Mustfile missing required security settings"
        exit 1
    fi
else
    echo -e "${YELLOW}SKIP${NC} (no Mustfile)"
fi

echo ""
echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
