#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Hyperpolymath
#
# Pre-push hook - Final validation before push

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║           SVALINN VAULT PRE-PUSH VALIDATION                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"

# Get remote and branch
remote="$1"
url="$2"

# Read pushed refs
while read local_ref local_oid remote_ref remote_oid
do
    # ===========================================================================
    # Prevent push to protected branches without PR
    # ===========================================================================
    if [[ "$remote_ref" =~ refs/heads/(main|master|release) ]]; then
        echo -e "${RED}BLOCKED${NC}: Direct push to protected branch: $remote_ref"
        echo "Please create a pull request instead."
        exit 1
    fi

    # ===========================================================================
    # Verify all commits are signed
    # ===========================================================================
    echo -n "Verifying commit signatures... "
    if [ "$remote_oid" = "0000000000000000000000000000000000000000" ]; then
        # New branch
        COMMITS=$(git rev-list "$local_oid" --not --remotes)
    else
        COMMITS=$(git rev-list "$remote_oid..$local_oid")
    fi

    for commit in $COMMITS; do
        if ! git verify-commit "$commit" 2>/dev/null; then
            echo -e "${RED}FAIL${NC}"
            echo "Unsigned commit: $commit"
            echo "All commits must be GPG or SSH signed."
            exit 1
        fi
    done
    echo -e "${GREEN}PASS${NC}"

    # ===========================================================================
    # Run tests
    # ===========================================================================
    echo -n "Running tests... "
    if [ -d "vault-core-ats" ]; then
        if command -v zig &> /dev/null; then
            cd vault-core-ats
            if zig build test 2>/dev/null; then
                echo -e "${GREEN}PASS${NC}"
            else
                echo -e "${RED}FAIL${NC}"
                echo "Tests failed. Fix before pushing."
                exit 1
            fi
            cd ..
        else
            echo -e "${YELLOW}SKIP${NC} (zig not installed)"
        fi
    else
        echo -e "${YELLOW}SKIP${NC} (no vault-core-ats)"
    fi

    # ===========================================================================
    # Security audit
    # ===========================================================================
    echo -n "Running security audit... "
    if command -v gitleaks &> /dev/null; then
        if gitleaks detect --source . --no-git --quiet 2>/dev/null; then
            echo -e "${GREEN}PASS${NC}"
        else
            echo -e "${RED}FAIL${NC}"
            echo "Security audit failed!"
            exit 1
        fi
    else
        echo -e "${YELLOW}SKIP${NC} (gitleaks not installed)"
    fi

    # ===========================================================================
    # Check for large files
    # ===========================================================================
    echo -n "Checking file sizes... "
    MAX_SIZE=$((10 * 1024 * 1024))  # 10 MB
    LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read f; do
        if [ -f "$f" ]; then
            size=$(stat -c%s "$f" 2>/dev/null || echo 0)
            if [ "$size" -gt "$MAX_SIZE" ]; then
                echo "$f ($size bytes)"
            fi
        fi
    done || true)

    if [ -n "$LARGE_FILES" ]; then
        echo -e "${YELLOW}WARN${NC}"
        echo "  Large files detected: $LARGE_FILES"
    else
        echo -e "${GREEN}PASS${NC}"
    fi

done

echo ""
echo -e "${GREEN}All pre-push checks passed!${NC}"
exit 0
