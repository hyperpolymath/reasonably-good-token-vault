# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Hyperpolymath
#
# Release Pipeline - Multi-Platform Packaging

name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # ===========================================================================
  # Build All Platforms
  # ===========================================================================

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Build
        working-directory: vault-core-ats
        run: |
          zig build -Dtarget=${{ matrix.arch }}-linux-gnu -Doptimize=ReleaseSafe

      - name: Package
        run: |
          mkdir -p dist
          cp vault-core-ats/zig-out/bin/svalinn-cli dist/
          tar -czvf svalinn-vault-linux-${{ matrix.arch }}.tar.gz -C dist .

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: svalinn-vault-linux-${{ matrix.arch }}.tar.gz

  build-windows:
    name: Build Windows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Build
        working-directory: vault-core-ats
        run: |
          zig build -Dtarget=x86_64-windows-gnu -Doptimize=ReleaseSafe

      - name: Package
        run: |
          mkdir -p dist
          cp vault-core-ats/zig-out/bin/svalinn-cli.exe dist/
          zip -j svalinn-vault-windows-x64.zip dist/*

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: svalinn-vault-windows-x64.zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Build
        working-directory: vault-core-ats
        run: |
          zig build -Dtarget=${{ matrix.arch }}-macos -Doptimize=ReleaseSafe

      - name: Package
        run: |
          mkdir -p dist
          cp vault-core-ats/zig-out/bin/svalinn-cli dist/
          tar -czvf svalinn-vault-macos-${{ matrix.arch }}.tar.gz -C dist .

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: svalinn-vault-macos-${{ matrix.arch }}.tar.gz

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Build for Android
        working-directory: vault-core-ats
        run: |
          zig build android -Doptimize=ReleaseSafe

      - name: Package AAR
        run: |
          mkdir -p android-lib/jniLibs/arm64-v8a
          cp vault-core-ats/zig-out/lib/*.so android-lib/jniLibs/arm64-v8a/
          zip -r svalinn-vault-android.zip android-lib/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: svalinn-vault-android.zip

  # ===========================================================================
  # Build Packages
  # ===========================================================================

  build-deb:
    name: Build Debian Package
    needs: [build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: linux-x86_64

      - name: Build .deb
        run: |
          mkdir -p deb/DEBIAN deb/usr/bin
          tar -xzf svalinn-vault-linux-x86_64.tar.gz -C deb/usr/bin/
          cp packaging/debian/control deb/DEBIAN/
          dpkg-deb --build deb svalinn-vault_0.1.0_amd64.deb

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: deb
          path: svalinn-vault_0.1.0_amd64.deb

  build-rpm:
    name: Build RPM Package
    needs: [build-linux]
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install RPM Build Tools
        run: dnf install -y rpm-build rpmdevtools

      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: linux-x86_64

      - name: Build .rpm
        run: |
          rpmdev-setuptree
          cp packaging/rpm/svalinn-vault.spec ~/rpmbuild/SPECS/
          tar -xzf svalinn-vault-linux-x86_64.tar.gz
          # Build RPM
          rpmbuild -bb ~/rpmbuild/SPECS/svalinn-vault.spec || true

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: rpm
          path: ~/rpmbuild/RPMS/

  # ===========================================================================
  # Publish Release
  # ===========================================================================

  publish-release:
    name: Publish GitHub Release
    needs: [build-linux, build-windows, build-macos, build-android, build-deb, build-rpm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate Checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.deb" -o -name "*.rpm" \) -exec sha256sum {} \; > SHA256SUMS

      - name: Sign Checksums
        run: |
          # GPG sign (would use actual key in production)
          echo "Checksums generated - GPG signing would happen here"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/SHA256SUMS
          generate_release_notes: true
          body: |
            ## Svalinn Vault Release

            ### Security Features
            - Post-quantum cryptography (Kyber-1024, Dilithium5)
            - Classical cryptography (Ed448, AES-256-GCM, BLAKE3)
            - Argon2id key derivation (64 MiB)
            - GUID-based storage with redaction
            - chmod 000 lockdown

            ### Installation
            See README.adoc for installation instructions.

            ### Verification
            All files are SHA256 checksummed. Verify with:
            ```
            sha256sum -c SHA256SUMS
            ```

            ⚠️ **DUAL-USE TECHNOLOGY WARNING**: See LICENSE for details.

  publish-container:
    name: Publish Container
    needs: [build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: container/svalinn.containerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}:latest
