# SPDX-License-Identifier: MPL-2.0-or-later
# SPDX-FileCopyrightText: 2025 Hyperpolymath
#
# RGT Vault rpm-ostree overlay configuration
# (Reasonably Good Token Vault - built on Svalinn container)
# For use with Fedora Silverblue, Kinoite, CoreOS, etc.

# Install as layered package
# rpm-ostree install rgt-vault

# Or include in custom ostree compose:
ref: rgt-vault/${basearch}

rojig:
  name: rgt-vault
  summary: "RGT Vault - Reasonably Good Token Vault (post-quantum secure)"
  license: AGPL-3.0-or-later

packages:
  - rgt-vault

# Remove packages that conflict with security requirements
packages-remove:
  - telnet
  - rsh
  - ftp

# Packages to include in base image
include:
  - fedora-minimal.yaml

# Add SELinux policy
add-files:
  - - rgt-vault.te
    - /usr/share/selinux/packages/rgt-vault.te

# Post-installation commands
postprocess:
  - |
    #!/bin/bash
    set -euo pipefail

    # Compile and install SELinux policy
    if [ -f /usr/share/selinux/packages/rgt-vault.te ]; then
      checkmodule -M -m -o /tmp/rgt-vault.mod /usr/share/selinux/packages/rgt-vault.te
      semodule_package -o /tmp/rgt-vault.pp -m /tmp/rgt-vault.mod
      semodule -i /tmp/rgt-vault.pp
      rm -f /tmp/rgt-vault.mod /tmp/rgt-vault.pp
    fi

    # Create vault directories
    mkdir -p /var/lib/rgt-vault/vault
    mkdir -p /var/lib/rgt-vault/jail
    chmod 700 /var/lib/rgt-vault
    chmod 000 /var/lib/rgt-vault/vault  # Locked by default

    # Set up firewalld zone
    if [ -d /etc/firewalld/zones ]; then
      cat > /etc/firewalld/zones/rgt-vault.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<zone target="DROP">
  <short>RGT-Vault</short>
  <description>Maximum security zone for RGT Vault - IPv6 only</description>
  <service name="dhcpv6-client"/>
</zone>
EOF
    fi

# Ensure immutability of critical files
preserve-only:
  - /usr/bin/rgt-vault
  - /usr/lib/librgt_crypto.a
  - /usr/share/selinux/packages/rgt-vault.te

# Container configuration for rpm-ostree containers
container:
  base: quay.io/fedora/fedora-coreos:stable
  labels:
    io.opencontainers.image.title: "RGT Vault (Reasonably Good Token Vault)"
    io.opencontainers.image.description: "Post-quantum secure identity vault - a parody of PGP"
    io.opencontainers.image.source: "https://github.com/hyperpolymath/reasonable-good-token-vault"
    io.opencontainers.image.licenses: "AGPL-3.0-or-later"
    io.opencontainers.image.documentation: "https://github.com/hyperpolymath/reasonable-good-token-vault#readme"
