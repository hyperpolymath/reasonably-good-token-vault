# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Hyperpolymath
# Maintainer: Hyperpolymath <security@hyperpolymath.example>

pkgname=svalinn-vault
pkgver=0.1.0
pkgrel=1
pkgdesc="Post-quantum secure identity vault with Kyber-1024 and Dilithium5"
arch=('x86_64' 'aarch64')
url="https://github.com/hyperpolymath/reasonable-good-token-vault"
license=('AGPL-3.0-or-later')
depends=('openssl' 'blake3')
makedepends=('ats2' 'zig' 'git')
optdepends=(
    'selinux-policy: SELinux support'
    'firewalld: Firewall configuration'
    'wireguard-tools: VPN support'
)
source=("git+https://github.com/hyperpolymath/reasonable-good-token-vault.git#tag=v${pkgver}")
sha256sums=('SKIP')

build() {
    cd "reasonable-good-token-vault"

    # Build Zig crypto library
    cd vault-core-ats
    zig build -Doptimize=ReleaseSafe

    # Build ATS core
    make build
}

check() {
    cd "reasonable-good-token-vault/vault-core-ats"
    zig build test
}

package() {
    cd "reasonable-good-token-vault"

    install -Dm755 vault-core-ats/svalinn-vault-core "$pkgdir/usr/bin/svalinn-cli"
    install -Dm644 vault-core-ats/zig-out/lib/libsvalinn_crypto.a "$pkgdir/usr/lib/libsvalinn_crypto.a"
    install -Dm644 container/config/selinux/svalinn.te "$pkgdir/usr/share/selinux/packages/svalinn.te"
    install -Dm644 README.adoc "$pkgdir/usr/share/doc/$pkgname/README.adoc"
    install -Dm644 LICENSES/AGPL-3.0-or-later.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
