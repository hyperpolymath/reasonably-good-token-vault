# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Hyperpolymath
# Maintainer: Hyperpolymath <security@hyperpolymath.example>

pkgname=rgt-vault
pkgver=0.1.0_alpha
pkgrel=1
pkgdesc="RGT Vault - Reasonably Good Token Vault. Post-quantum secure identity vault."
arch=('x86_64' 'aarch64')
url="https://github.com/hyperpolymath/reasonable-good-token-vault"
license=('AGPL-3.0-or-later')
depends=('openssl' 'blake3')
makedepends=('ats2' 'zig' 'git')
optdepends=(
    'selinux-policy: SELinux support'
    'firewalld: Firewall configuration'
    'wireguard-tools: VPN support'
)
source=("git+https://github.com/hyperpolymath/reasonable-good-token-vault.git#tag=v0.1.0-alpha")
sha256sums=('SKIP')

build() {
    cd "reasonable-good-token-vault"

    # Build Zig crypto library
    cd vault-core-ats
    zig build -Doptimize=ReleaseSafe

    # Build ATS core
    make build
}

check() {
    cd "reasonable-good-token-vault/vault-core-ats"
    zig build test
}

package() {
    cd "reasonable-good-token-vault"

    install -Dm755 vault-core-ats/rgt-vault "$pkgdir/usr/bin/rgt-vault"
    install -Dm644 vault-core-ats/zig-out/lib/librgt_crypto.a "$pkgdir/usr/lib/librgt_crypto.a"
    install -Dm644 container/config/selinux/svalinn.te "$pkgdir/usr/share/selinux/packages/rgt-vault.te"
    install -Dm644 README.adoc "$pkgdir/usr/share/doc/$pkgname/README.adoc"
    install -Dm644 LICENSES/AGPL-3.0-or-later.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
